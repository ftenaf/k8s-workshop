# Installation de Flux

----

<img class="r-stretch" src="../images/one-kubernetes_Sigero.png">

## La CLI

1. L'√©quipe **ops** r√©cup√®re la _CLI_ `Flux` sur son poste de travail
1. La _CLI_ va s'appuyer sur la configuration `kubectl` pour interagir avec le _cluster_
   * connectivit√© r√©seau
   * droits _RBAC_

----

## Pr√©-contr√¥les

1. On s'assure que
   * la CLI se connecte bien
   * que les versions de `Flux` et de `Kubernetes` sont OK

```bash
$ flux check ---pre
```

----

## Le d√©p√¥t git de configuration Flux

* La CLI va cr√©er un d√©p√¥t `fleet-infra` dans notre organisation `Github` : `one-kubernetes`
* Elle a besoin d'un _token_ `Github` capable de _CRUD_ sur les d√©p√¥ts.

----

<img class="r-stretch" src="../images/github_add_token.png">

----

* `Flux` peut aussi indiquer les √©quipes qui auront le droit de modifier cette configuration.
* Il faut que ces √©quipes fassent d√©j√† partie de l'organisation.

<img class="r-stretch" src="../images/github_teams.jpg">


----

* ‚ö†Ô∏è Ici on vous montre pour l'exemple, mais dans le reste du _workshop_ (comme dans la vraie vie) les diff√©rentes √©quipes n'ont pas besoin d'acc√©der √† ce d√©p√¥t.  
* C'est tout l'avantage des sources de configuration multiples.

----

### Cr√©ation du d√©p√¥t dans `Github`

```bash [1-3|5-10]
$ export GITHUB_TOKEN="<insert your Github personal token here>"
$ export GITHUB_USER="one-kubernetes"
$ export GITHUB_REPO="fleet-infra"

$ flux bootstrap github         \
    --owner=${GITHUB_USER}      \
    --repository=${GITHUB_REPO} \
    --team=dev1                 \
    --team=dev2                 \
    --path=clusters/cloudsud
```

----

<img class="r-stretch" src="../images/flux_config_files.jpg">

----

### üìÑ gotk-sync.yaml

```yaml [2-14|15-27]
# This manifest was generated by flux. DO NOT EDIT.
---
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: GitRepository
metadata:
  name: flux-system
  namespace: flux-system
spec:
  interval: 1m0s
  ref:
    branch: main
  secretRef:
    name: flux-system
  url: ssh://git@github.com/one-kubernetes/fleet-infra
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: flux-system
  namespace: flux-system
spec:
  interval: 10m0s
  path: ./clusters/snowcamp
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
```

----

### üìÑ kustomization.yaml

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- gotk-components.yaml
- gotk-sync.yaml
```

----

### R√©cup√©ration du d√©p√¥t en local

```bash
$ git clone https://github.com/${GITHUB_USER}/${GITHUB_REPO}
```

---

## Cr√©ation d'une config. `staging` et `prod`

<img class="r-stretch" src="../images/one-kubernetes_Sigero.png">

* **ops** va scinder son _cluster_ en 2 : `staging` et `prod`
* Grace √† _Kustomize_, elle va
  1. cr√©er une config. de base
  2. qui sera surcharg√©e par une config. sp√©cifique au _tenant_
* üí°√áa para√Æt compliqu√©, mais pas d'inqui√©tude : la _CLI_ `Flux` s'occupe de l'essentiel

----

```bash [1|2-8]
$ cd ./fleet-infra
$ flux create kustomization tenants    \
    --namespace=flux-system            \
    --source=GitRepository/flux-system \
    --path ./tenants/staging           \
    --prune                            \
    --interval=3m                      \
    --export >> clusters/cloudsud/tenants.yaml
```

----

### üìÑ tenants.yaml

```yaml
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: tenants
  namespace: flux-system
spec:
  interval: 5m0s
  path: ./tenants/staging
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
```

----

> ‚ö†Ô∏è N'oubliez pas de `git commit` et `git push` vers Github : c'est la source qui va √™tre scrut√©e par `Flux`.

